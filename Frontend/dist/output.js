(()=>{"use strict";async function e(e,t){(e=new URL(e)).search=new URLSearchParams(t);const n=await fetch(e);if(!n.ok)throw n;return n}function t(e){return 1-Math.pow(1-e,3)}function n(e){return 1-Math.pow(1-e,4)}const o=1,a=1e3,s=1,c="EN",i=[["EN","English"],["TR","Turkish"]],r=["#ff1744","#f50057","#d500f9","#651fff","#3d5afe","#2979ff","#008573","#008c3a","#ff6d00","#dd2c00"],l=[4294967295,4292466644,4287663497,4278190080,4280773020,4281223277,4289304831,4286658815,4290792115,4288618113,4294925419,4290853450,4294240593,4293496630,4288892963,4289371648,4285494528,4283886975,4286041088,4285047808,4281718527,4278233343,4278207999,4281860285];let d=!1,u=!1,m=!1,f={},y=Math.min(innerWidth,innerHeight)/(2*a);const h={offset:{x:0,y:0},zoom:y},p=document.getElementById("board-wrapper");function g(e){return{x:e.touches[0].clientX+e.touches[1].clientX,y:e.touches[0].clientY+e.touches[1].clientY,distance:Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY)}}function x(e){return{x:e instanceof TouchEvent?e.touches[0].clientX:e.clientX,y:e instanceof TouchEvent?e.touches[0].clientY:e.clientY}}function b(){d=!1,u=!1}function w(e){d=!0,m=!1,u=e instanceof TouchEvent&&2===e.touches.length,f=u?g(e):x(e)}function E(e){if(m=!0,d){const t=u?g(e):x(e),n=(t.x-f.x)/h.zoom,o=(t.y-f.y)/h.zoom;if(u){const e=t.distance/f.distance*h.zoom,n=Math.max(Math.min(e,50),y);h.zoom=n,Q(h),Z(h)}f=t,B(n,o),V(h)}}function I(e){e.preventDefault();const t=Math.sign(-e.deltaY)>0?1.732*h.zoom:h.zoom/1.732,n=Math.max(Math.min(t,50),y),o=z(e),a=o.x/n-o.x/h.zoom,s=o.y/n-o.y/h.zoom;h.zoom=n,B(a,s),Q(h),V(h),Z(h)}function v(e){if(!m){const n=z(e),o=-(n.x-h.offset.x*h.zoom)/h.zoom,a=-(n.y-h.offset.y*h.zoom)/h.zoom;function s(e){h.offset=e,V(h)}T(700,t,{x:h.offset.x,y:h.offset.y},{x:o,y:a},s)}}function M(){return{x:Math.floor(Math.abs(h.offset.x/o)),y:Math.floor(Math.abs(h.offset.y/o))}}function B(e,t){h.offset.x=Math.max(Math.min(e+h.offset.x,0),.1-a),h.offset.y=Math.max(Math.min(t+h.offset.y,0),.1-a)}function z(e){return{x:(e instanceof TouchEvent?e.touches[0].clientX:e.clientX)-p.offsetLeft,y:(e instanceof TouchEvent?e.touches[0].clientY:e.clientY)-p.offsetTop}}function T(e,t,n,o,a){function s(c,i){const r=c-i;if(r<e){const c=t(r/e);let l;l=n instanceof Object?{x:n.x+(o.x-n.x)*c,y:n.y+(o.y-n.y)*c}:n+(o-n)*c,a(l),requestAnimationFrame((e=>s(e,i)))}}requestAnimationFrame((e=>s(e,e)))}window.addEventListener("load",(()=>{const e=document.getElementById("scene");e.onwheel=I,e.onmousedown=w,e.onmousemove=E,e.ontouchstart=w,e.ontouchmove=E,e.ontouchend=b,document.getElementsByTagName("body")[0].onmouseup=b,document.getElementById("board-wrapper").onclick=v}));const L=document.getElementById("palette"),k=document.getElementById("pixel-preview");function C(){L.style.transform="translate(-50%, 0)",function(){if(h.zoom<21){let e=0,t=0;for(;e<21;)e=h.zoom*1.275**t,t+=1;function o(e){h.zoom=e,Q(h),Z(h)}T(700,n,h.zoom,e,o)}}()}function $(){k.style.visibility="hidden";const e=L.getElementsByTagName("button").item(1);e.disabled=!0,e.style.cursor="not-allowed";const t=document.querySelector("[data-selected]");t?.removeAttribute("data-selected"),t?.classList?.remove("animate-heartbeat"),L.style.transform="translate(-50%, 100%)"}function S(e){const t=e.toString(16).padStart(8,"0");return"#"+t.substring(6)+t.substring(4,6)+t.substring(2,4)}function A(){document.getElementById("content-main").style.display="none",document.getElementById("content-loading").style.display="none",document.getElementById("content-offline").style.display="flex"}window.addEventListener("load",(()=>{document.getElementById("place").onclick=C,L.getElementsByTagName("button").item(0).onclick=$,L.getElementsByTagName("button").item(1).onclick=K}));const H="http://localhost:5027/",N=H+"api/chat",R=H+"hub/chat",U=H+"hub/board",Y=N+"/cache-message",X=N+"/group-messages",j=H+"api/board",q=document.getElementById("posale"),O=document.getElementById("board-wrapper"),P=document.getElementById("pixel-select"),D=document.getElementById("pixel-preview"),F=document.getElementById("canvas").getContext("2d"),J=(new signalR.HubConnectionBuilder).withUrl(U).build(),G=new Uint32Array(a**2);function W(){F.putImageData(new ImageData(new Uint8ClampedArray(G.buffer),a,a),0,0),requestAnimationFrame(W)}async function K(){const e=M(),t=document.querySelector("[data-selected]"),n={boardIndex:e.x+1e3*e.y,colorIndex:Number(t.dataset.cindex)};G[n.boardIndex]=l[n.colorIndex],await J.invoke("SendPixel",n),$()}function Q(e){O.style.transform=`scale(${e.zoom}) translate(${e.offset.x}px, ${e.offset.y}px)`,q.children[1].innerHTML=(e.zoom<1?e.zoom.toFixed(1):Math.round(e.zoom))/10+"x"}function V(e){const t=M(),n=t.x*o,a=t.y*o;O.style.transform=`scale(${e.zoom}) translate(${e.offset.x}px, ${e.offset.y}px)`,P.style.transform=`translate(${n}px, ${a}px)`,D.style.transform=`translate(${n}px, ${a}px)`,q.children[0].innerHTML=`(${t.x},${t.y}) `}function Z(e){e.zoom>s?O.style.imageRendering="pixelated":O.style.imageRendering="initial"}let _=JSON.parse(localStorage.getItem("user"));const ee=[],te=(new signalR.HubConnectionBuilder).withUrl(R).build(),ne=document.getElementById("chat"),oe=document.getElementById("chat-lang"),ae=document.getElementById("chat-body"),se=document.getElementById("chat-input"),ce=document.getElementById("chat-dropdown");async function ie(){const e=async()=>{ne.style.transform="translate(0, 0)",de()||(ae.style.justifyContent="center",ae.style.alignItems="center",ae.innerHTML='<img src="./assets/spinners/ring.svg" width="80" height="80" alt="Spinner">',await te.start(),await fe(c),ae.style.justifyContent="flex-start",ae.style.alignItems="flex-start",ae.innerHTML="")};_?.username?e():function(e){const t=prompt("Enter a username"),n=_?.color?_.color:r[Math.floor(Math.random()*r.length)];t&&t.length>0&&t.length<56?(_={username:t,color:n},localStorage.setItem("user",JSON.stringify(_)),e()):alert("It cannot be empty and greater than 56 chars")}(e)}function re(){ne.style.transform="translate(100%, 0)",ce.style.display="none"}function le(e){e.stopPropagation(),ce.style.display="flex"}function de(){return te.state===signalR.HubConnectionState.Connected}function ue(e){const t={connectionId:te.connectionId};e.group===oe.dataset.group&&ye(e),function(e,t,n){(e=new URL(e)).search=new URLSearchParams(n),fetch(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)})}(Y,e,t)}async function me(t,n){if(de()){if(n!==oe.dataset.group){ae.innerHTML="";try{const t={connectionId:te.connectionId,group:n},o=await e(X,t),a=await o.json();for(const e of a)ye(JSON.parse(e))}catch(e){alert("Couldn't fetch previous messages")}finally{await fe(n),oe.children[0].src=`./assets/flags/${n}.png`,oe.children[1].innerHTML=n}}}else alert("Can't connect to chat server");!function(e){e.stopPropagation(),ce.style.display="none"}(t)}async function fe(e){oe.setAttribute("data-group",e),ee.some((t=>t===e))||(await te.invoke("AddToGroup",e),te.on("ReceiveGroupMessage"+e,(e=>ue(e))),ee.push(e))}function ye(e){const t=document.createElement("span");t.style.userSelect="text",t.innerHTML=`<span class="mr-1" style="color: ${e.color};">[${e.username}]:</span>${e.text}`,ae.appendChild(t)}window.addEventListener("load",(()=>{oe.onclick=le,se.onkeydown=e=>{"Enter"===e.key&&(e.preventDefault(),function(){if(de()){const e={group:oe.dataset.group,username:_.username,text:se.value,color:_.color};te.invoke("SendGroupMessage",e),ue(e)}else alert("Can't connect to chat server");se.value=""}())},ne.onclick=e=>{ce.style.display="none"},document.getElementById("chat-open").onclick=ie,document.getElementById("chat-close").onclick=re})),window.addEventListener("load",(async()=>{try{await async function(){const t=await e(j),n=new Uint8Array(await t.arrayBuffer()),o={offset:{x:0,y:0},zoom:Math.min(innerWidth,innerHeight)/(2*a)};for(let e=0;e<a**2;e++)G[e]=l[n[e]];F.putImageData(new ImageData(new Uint8ClampedArray(G.buffer),a,a),0,0),Q(o),V(o),Z(o),await J.start(),J.on("ReceivePixel",(e=>G[e.boardIndex]=l[e.colorIndex])),J.onclose((e=>A())),requestAnimationFrame(W)}(),function(){const e=L.getElementsByTagName("button").item(1);for(const t of Array.from(l).reverse()){const n=document.createElement("div"),o=S(t);n.classList.add("palette-cbox"),n.style.backgroundColor=o,n.setAttribute("data-cindex",l.indexOf(t)),n.onclick=()=>{const t=document.querySelector("[data-selected]");t?.removeAttribute("data-selected"),t?.classList?.remove("animate-heartbeat"),n.setAttribute("data-selected",!0),n.classList.add("animate-heartbeat"),k.style.visibility="visible",k.style.backgroundColor=o,e.disabled=!1,e.style.cursor="pointer"},L.children[0].appendChild(n)}}(),function(){for(const[e,t]of i){const n=document.createElement("li");n.onclick=t=>me(t,e),n.className="flex items-center justify-between gap-12 cursor-pointer",n.innerHTML=`<span class="font-medium text-sm">${t}</span>\n                        <img class="max-w-none" src="./assets/flags/${e}.png" alt="${t}">`,ce.children[0].appendChild(n)}}(),function(){const e=document.createElement("img"),t=document.createElement("span");e.src=`./assets/flags/${c}.png`,t.className="font-inter font-medium text-sm",t.innerHTML=c,oe.appendChild(e),oe.appendChild(t),oe.setAttribute("data-group",c)}(),document.getElementById("content-loading").style.display="none",document.getElementById("content-main").style.display="block"}catch(e){A()}}))})();